# batch_runner.py
import simulation
import time
import os

# --- å®éªŒé…ç½® ---
SCARCITY_LEVELS = ["FAMINE"]

# 3ç§åŒè´¨åŒ–äººæ ¼ç»„
PERSONALITY_GROUPS = {
    "All_Aggressive": ["Aggressive", "Aggressive", "Aggressive"],
    "All_Altruistic": ["Altruistic", "Altruistic", "Altruistic"],
    "All_Dominant": ["Dominant", "Dominant", "Dominant"]
}

# --- æµ‹è¯•æ¨¡å¼è®¾ç½® ---
# ğŸ”´ æ­£å¼è·‘çš„æ—¶å€™æ”¹æˆ 50 å’Œ 50
NUM_RUNS_PER_GROUP = 50   
MAX_TURNS = 50           

def main():
    total_experiments = len(SCARCITY_LEVELS) * len(PERSONALITY_GROUPS) * NUM_RUNS_PER_GROUP
    count = 0

    print(f"ğŸ”¥ Batch Started. Total: {total_experiments}, Turns: {MAX_TURNS}")

    for scarcity in SCARCITY_LEVELS:
        for p_name, p_list in PERSONALITY_GROUPS.items():
            for i in range(1, NUM_RUNS_PER_GROUP + 1):
                count += 1
                
                # ç”Ÿæˆ ID
                run_id = f"{scarcity}_{p_name}_{i:02d}"
                target_log_file = f"logs/experiment_{run_id}.jsonl"
                
                # ğŸ”´ æ ¸å¿ƒä¿®æ”¹ï¼šæ–­ç‚¹ç»­ä¼ æ£€æŸ¥
                # å¦‚æœè¿™ä¸ª ID çš„æ—¥å¿—æ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œä¸”å¤§å°ä¸ä¸º 0ï¼Œè¯´æ˜è·‘è¿‡äº†ï¼Œè·³è¿‡
                if os.path.exists(target_log_file) and os.path.getsize(target_log_file) > 0:
                    print(f"â© [{count}/{total_experiments}] Skipping {run_id} (Already done)")
                    continue
                
                # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¸ºç©ºï¼ˆä¸Šæ¬¡è·‘æŒ‚äº†ï¼‰ï¼Œåˆ™å¼€å§‹è¿è¡Œ
                print(f"\nâ–¶ï¸ [{count}/{total_experiments}] Running {run_id} ...")
                
                try:
                    simulation.run_simulation(
                        run_id=run_id,
                        scarcity_mode=scarcity,
                        personalities=p_list,
                        max_turns=MAX_TURNS
                    )
                except Exception as e:
                    print(f"âŒ Error in {run_id}: {e}")
                    # æŠŠé”™è¯¯è®°å½•åˆ°ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œæ–¹ä¾¿ä½ èµ·åºŠçœ‹
                    with open("logs/_error_log.txt", "a") as ef:
                        ef.write(f"{run_id}: {str(e)}\n")
                
                # ğŸ”´ å»ºè®®ï¼šæ¯è·‘å®Œä¸€æ¬¡ï¼Œä¼‘æ¯ 2-5 ç§’ï¼Œä¿æŠ¤ API
                time.sleep(2)

if __name__ == "__main__":
    main()
